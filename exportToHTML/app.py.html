<html>
<head>
<title>app.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #a9b7c6;}
.s1 { color: #cc7832;}
.s2 { color: #808080;}
.s3 { color: #6a8759;}
.s4 { color: #6897bb;}
.s5 { color: #629755; font-style: italic;}
</style>
</head>
<body bgcolor="#2b2b2b">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
app.py</font>
</center></td></tr></table>
<pre>
<span class="s1">import </span><span class="s0">os</span>
<span class="s1">import </span><span class="s0">random</span>
<span class="s1">import </span><span class="s0">string</span>
<span class="s1">import </span><span class="s0">json</span>

<span class="s1">import </span><span class="s0">re</span><span class="s1">, </span><span class="s0">bcrypt</span>

<span class="s1">from </span><span class="s0">flask </span><span class="s1">import </span><span class="s0">Flask</span><span class="s1">, </span><span class="s0">render_template</span><span class="s1">, </span><span class="s0">flash</span><span class="s1">, </span><span class="s0">session</span><span class="s1">, </span><span class="s0">redirect</span><span class="s1">, </span><span class="s0">url_for</span><span class="s1">, </span><span class="s0">request</span><span class="s1">, </span><span class="s0">jsonify</span>
<span class="s1">from </span><span class="s0">formx </span><span class="s1">import </span><span class="s0">Registrationform</span><span class="s1">, </span><span class="s0">Loginform</span><span class="s1">, </span><span class="s0">Confirmation_code</span><span class="s1">, </span><span class="s0">recover_password_form</span><span class="s1">, </span><span class="s0">code_verification_form</span><span class="s1">, </span><span class="s0">changing_password</span>
<span class="s1">from </span><span class="s0">flask_sqlalchemy </span><span class="s1">import </span><span class="s0">SQLAlchemy</span>
<span class="s1">from </span><span class="s0">flask_session </span><span class="s1">import </span><span class="s0">Session</span>
<span class="s1">from </span><span class="s0">flask_mail </span><span class="s1">import </span><span class="s0">Mail</span><span class="s1">, </span><span class="s0">Message</span>
<span class="s1">from </span><span class="s0">flask_socketio </span><span class="s1">import </span><span class="s0">SocketIO</span><span class="s1">, </span><span class="s0">join_room</span><span class="s1">, </span><span class="s0">leave_room</span><span class="s1">, </span><span class="s0">emit</span>


<span class="s2"># try:</span>
<span class="s2">#     json.load()</span>
<span class="s2"># except ValueError:</span>
<span class="s2">#     print(&quot;error&quot;)</span>

<span class="s1">from </span><span class="s0">os </span><span class="s1">import </span><span class="s0">path</span>


<span class="s0">DB_NAME = </span><span class="s3">&quot;database.db&quot;</span>
<span class="s0">os.environ[</span><span class="s3">'password'</span><span class="s0">] = </span><span class="s3">&quot;mail0480*&quot;</span>

<span class="s0">app = Flask(__name__)</span>

<span class="s0">app.config[</span><span class="s3">'SECRET_KEY'</span><span class="s0">] = </span><span class="s3">&quot;Management Engineering&quot;</span>
<span class="s0">app.config[</span><span class="s3">'SQLALCHEMY_DATABASE_URI'</span><span class="s0">] = </span><span class="s3">'sqlite:///database.db'</span>
<span class="s0">app.config[</span><span class="s3">'SQLALCHEMY_COMMIT_ON_TEARDOWN'</span><span class="s0">] = </span><span class="s1">True</span>

<span class="s0">app.config[</span><span class="s3">'MAIL_USERNAME'</span><span class="s0">] = </span><span class="s3">&quot;BookTOStudy@mail.com&quot;</span>
<span class="s0">app.config[</span><span class="s3">'MAIL_PASSWORD'</span><span class="s0">] =  os.getenv(</span><span class="s3">'password'</span><span class="s0">)</span>
<span class="s0">app.config[</span><span class="s3">'MAIL_TLS'</span><span class="s0">] = </span><span class="s1">True</span>
<span class="s0">app.config[</span><span class="s3">'MAIL_SERVER'</span><span class="s0">] = </span><span class="s3">'smtp.mail.com'</span>
<span class="s0">app.config[</span><span class="s3">'MAIL_PORT'</span><span class="s0">] = </span><span class="s4">587</span>

<span class="s0">db = SQLAlchemy(app)</span>
<span class="s0">mail = Mail(app)</span>
<span class="s0">socketio = SocketIO(app</span><span class="s1">, </span><span class="s0">manage_session=</span><span class="s1">False</span><span class="s0">)</span>

<span class="s1">from </span><span class="s0">models </span><span class="s1">import </span><span class="s0">*</span>


<span class="s0">@app.before_first_request</span>
<span class="s1">def </span><span class="s0">create_db():</span>

    <span class="s0">print(</span><span class="s3">&quot;entered&quot;</span><span class="s0">)</span>

    <span class="s2"># confirmation_code=&quot;#$%303&quot;</span>
    <span class="s2"># confirmation_code=&quot;609TOR&quot;</span>
    <span class="s2"># confirmation_code=&quot;3TBOP4&quot;</span>

    <span class="s1">if not </span><span class="s0">path.exists(</span><span class="s3">'database.db'</span><span class="s0">):</span>
        <span class="s0">db.drop_all()</span>
        <span class="s0">db.create_all()</span>

        <span class="s0">description_verdi=</span><span class="s3">&quot;Placed in the city centre, just near Piazza Vittorio Veneto, next to Palazzo Nuovo, one of the headquarters of the University of Torino. It is a very nice place to study, quite and you can find easily electrical outlets. It is attended by university students coming from different department. It can be easily reached by different transport service and nearby you can find places to eat, drink or simply taking a break in front of river Po.&quot;</span>
        <span class="s0">description_grugliasco=</span><span class="s3">&quot; Located in the city of Grugliasco, in the outsides of Turin, you can book a seat in this charm study room.&quot; </span><span class="s0">\</span>
                               <span class="s3">&quot; Considered the calmest by the students, it can be the best choice to concentrate better &quot;</span>
        <span class="s0">description_sansalvario=</span><span class="s3">&quot; Also known as the 'Bunker', it is a bit stretch but it's located in the heart of one of the most lively neighborhoods of Turin!&quot;</span>
        <span class="s0">description_marcopolo=</span><span class="s3">&quot; Test study room to try capacity limitation demonstration &quot;</span>

        <span class="s0">nearby_places_verdi = </span><span class="s3">&quot;Piazza Vittorio Veneto with different bars for aperitif or drink only on both sides of the square (https://goo.gl/maps/5ZUdZL2fSn8676hR7)&quot; </span><span class="s0">\</span>
                              <span class="s3">&quot;McDonald's Torino Sant'Ottavio (https://goo.gl/maps/sTKEW9RXZrBcSB1L6)&quot;</span><span class="s0">\</span>
                              <span class="s3">&quot;Burger King (https://g.page/burgerkingtorinocentro?share)&quot;</span><span class="s0">\</span>
                              <span class="s3">&quot;Pacific Poke Restaurant Verdi (https://g.page/pacifik-poke-restaurant?share)&quot;</span><span class="s0">\</span>
                              <span class="s3">&quot;Caffe' Elena (https://goo.gl/maps/VfZJkt6VGvxuA2hGA)&quot;</span><span class="s0">\</span>
                              <span class="s3">&quot;Caffe' Verdi (https://g.page/caffeverdi-to?share)&quot;</span><span class="s0">\</span>
                              <span class="s3">&quot;Denim bar (https://maps.app.goo.gl/fHqFAuVy5AZUjzw1A)&quot;</span><span class="s0">\</span>
                              <span class="s3">&quot;Alice Pizza Torino Universita' (https://maps.app.goo.gl/tj4bxRLTgF5D2sjh6)&quot;</span><span class="s0">\</span>
                              <span class="s3">&quot;Curry &amp; Co (https://maps.app.goo.gl/4g6xTXgAUS3AKED96)&quot;</span><span class="s0">\</span>
                              <span class="s3">&quot;Ecoduemila (https://goo.gl/maps/WPKACfiZSGN3eA4z7)&quot;</span><span class="s0">\</span>
                              <span class="s3">&quot;Copy Digital Snc (https://g.page/Copydigital?share)&quot;</span>

        <span class="s0">aula_verdi = Room(name=</span><span class="s3">&quot;verdi&quot;</span><span class="s1">, </span><span class="s0">capacity=</span><span class="s4">143</span><span class="s1">, </span><span class="s0">description=description_verdi</span><span class="s1">, </span><span class="s0">confirmation_code=</span><span class="s3">&quot;#$%303&quot;</span><span class="s1">, </span><span class="s0">status=</span><span class="s4">0</span><span class="s1">, </span><span class="s0">internet=</span><span class="s3">&quot;Yes&quot;</span><span class="s1">, </span><span class="s0">socket=</span><span class="s3">&quot;Yes&quot;</span><span class="s1">, </span><span class="s0">bathroom=</span><span class="s3">&quot;Yes&quot;</span><span class="s1">, </span><span class="s0">vending_machine=</span><span class="s3">&quot;Yes&quot;</span><span class="s1">, </span><span class="s0">ac=</span><span class="s3">&quot;Yes&quot;</span><span class="s1">, </span><span class="s0">heating_system=</span><span class="s3">&quot;Yes&quot;</span><span class="s1">, </span><span class="s0">address=</span><span class="s3">&quot;via Verdi, 26 - 10124 Torino&quot;</span><span class="s1">, </span><span class="s0">copy_machine=</span><span class="s3">&quot;Yes&quot;</span><span class="s1">, </span><span class="s0">text_borrowing=</span><span class="s3">&quot;No&quot;</span><span class="s1">, </span><span class="s0">Smartcard_services=</span><span class="s3">&quot;Yes&quot;</span><span class="s1">, </span><span class="s0">Phone=</span><span class="s3">&quot;+39 011 6531290&quot;</span><span class="s1">, </span><span class="s0">Opening=</span><span class="s3">&quot;Monday-Friday: 8:30 AM to 00:00 AM. On public holidays, Sundays and Saturdays from 8:30 AM to 10:00 PM&quot;</span>
                          <span class="s1">, </span><span class="s0">nearby_places=nearby_places_verdi)</span>

        <span class="s0">aula_grugliasco = Room(name=</span><span class="s3">&quot;grugliasco&quot;</span><span class="s1">, </span><span class="s0">capacity=</span><span class="s4">150</span><span class="s1">, </span><span class="s0">description=description_grugliasco</span><span class="s1">, </span><span class="s0">confirmation_code=</span><span class="s3">&quot;609TOR&quot;</span><span class="s1">, </span><span class="s0">status=</span><span class="s4">0</span><span class="s1">, </span><span class="s0">internet=</span><span class="s3">&quot;Yes&quot;</span><span class="s1">, </span><span class="s0">socket=</span><span class="s3">&quot;Yes&quot;</span><span class="s1">, </span><span class="s0">bathroom=</span><span class="s3">&quot;Yes&quot;</span><span class="s1">, </span><span class="s0">vending_machine=</span><span class="s3">&quot;Yes&quot;</span><span class="s1">, </span><span class="s0">ac=</span><span class="s3">&quot;Yes&quot;</span><span class="s1">, </span><span class="s0">heating_system=</span><span class="s3">&quot;No&quot;</span><span class="s1">, </span><span class="s0">address=</span><span class="s3">&quot;Via Berta, 5, 10095 Grugliasco TO&quot;</span><span class="s0">)</span>

        <span class="s0">aula_sansalvario = Room(name=</span><span class="s3">&quot;sansalvario&quot;</span><span class="s1">, </span><span class="s0">capacity=</span><span class="s4">200</span><span class="s1">, </span><span class="s0">description=description_sansalvario</span><span class="s1">, </span><span class="s0">confirmation_code=</span><span class="s3">&quot;3TBOP4&quot;</span><span class="s1">, </span><span class="s0">status=</span><span class="s4">0</span><span class="s1">, </span><span class="s0">internet=</span><span class="s3">&quot;Yes&quot;</span><span class="s1">, </span><span class="s0">socket=</span><span class="s3">&quot;Yes&quot;</span><span class="s1">, </span><span class="s0">bathroom=</span><span class="s3">&quot;Yes&quot;</span><span class="s1">, </span><span class="s0">vending_machine=</span><span class="s3">&quot;No&quot;</span><span class="s1">, </span><span class="s0">ac=</span><span class="s3">&quot;No&quot;</span><span class="s1">, </span><span class="s0">heating_system=</span><span class="s3">&quot;No&quot;</span><span class="s1">, </span><span class="s0">address=</span><span class="s3">&quot;Via Pietro Giuria, 17, 10126 Torino TO&quot;</span><span class="s0">)</span>

        <span class="s0">aula_test = Room(name=</span><span class="s3">&quot;marcopolo&quot;</span><span class="s1">, </span><span class="s0">capacity=</span><span class="s4">2</span><span class="s1">, </span><span class="s0">description=description_marcopolo</span><span class="s1">, </span><span class="s0">confirmation_code=</span><span class="s3">&quot;123456&quot;</span><span class="s1">, </span><span class="s0">status=</span><span class="s4">0</span><span class="s1">, </span><span class="s0">internet=</span><span class="s3">&quot;Yes&quot;</span><span class="s1">, </span><span class="s0">socket=</span><span class="s3">&quot;No&quot;</span><span class="s1">, </span><span class="s0">bathroom=</span><span class="s3">&quot;No&quot;</span><span class="s1">, </span><span class="s0">vending_machine=</span><span class="s3">&quot;Yes&quot;</span><span class="s1">, </span><span class="s0">ac=</span><span class="s3">&quot;No&quot;</span><span class="s1">, </span><span class="s0">heating_system=</span><span class="s3">&quot;Yes&quot;</span><span class="s1">, </span><span class="s0">address=</span><span class="s3">&quot;Via Marco polo, 39, 10129 Torino TO&quot;</span><span class="s0">)</span>

        <span class="s0">db.session.add_all([aula_verdi</span><span class="s1">, </span><span class="s0">aula_grugliasco</span><span class="s1">, </span><span class="s0">aula_sansalvario</span><span class="s1">, </span><span class="s0">aula_test])</span>
        <span class="s0">db.session.commit()</span>

        <span class="s0">S = </span><span class="s4">6</span>
        <span class="s0">code = </span><span class="s3">''</span><span class="s0">.join(random.sample(string.ascii_uppercase + string.digits</span><span class="s1">, </span><span class="s0">k=S))</span>

        <span class="s0">CODE = Recovery_code(code=code)</span>

        <span class="s1">for </span><span class="s0">user </span><span class="s1">in </span><span class="s0">User.query.all():</span>
            <span class="s0">user.counter_booking = </span><span class="s4">0</span>

        <span class="s0">db.session.add(CODE)</span>
        <span class="s0">db.session.commit()</span>

        <span class="s0">print(</span><span class="s3">&quot;Database created&quot;</span><span class="s0">)</span>
    <span class="s1">else</span><span class="s0">:</span>

        <span class="s0">S = </span><span class="s4">6</span>
        <span class="s0">code = </span><span class="s3">''</span><span class="s0">.join(random.sample(string.ascii_uppercase + string.digits</span><span class="s1">, </span><span class="s0">k=S))</span>

        <span class="s0">CODE = Recovery_code(code=code)</span>

        <span class="s0">db.session.add(CODE)</span>

        <span class="s1">for </span><span class="s0">user </span><span class="s1">in </span><span class="s0">User.query.all():</span>
            <span class="s0">user.counter_booking = </span><span class="s4">0</span>

        <span class="s1">for </span><span class="s0">room </span><span class="s1">in </span><span class="s0">Room.query.all():</span>
            <span class="s0">room.status = </span><span class="s4">0</span>

        <span class="s0">db.session.commit()</span>

        <span class="s0">print(</span><span class="s3">&quot;Database found&quot;</span><span class="s0">)</span>


<span class="s1">def </span><span class="s0">flash_errors(form):</span>
    <span class="s5">&quot;&quot;&quot;Flashes form errors&quot;&quot;&quot;</span>
    <span class="s1">for </span><span class="s0">field</span><span class="s1">, </span><span class="s0">errors </span><span class="s1">in </span><span class="s0">form.errors.items():</span>
        <span class="s1">for </span><span class="s0">error </span><span class="s1">in </span><span class="s0">errors:</span>
            <span class="s0">flash(</span><span class="s3">u&quot;Error in the %s field - %s&quot; </span><span class="s0">% (</span>
                <span class="s0">getattr(form</span><span class="s1">, </span><span class="s0">field).label.text</span><span class="s1">,</span>
                <span class="s0">error</span>
            <span class="s0">)</span><span class="s1">, </span><span class="s0">category=</span><span class="s3">'failure'</span><span class="s0">)</span>


<span class="s1">def </span><span class="s0">send_mail_register(to</span><span class="s1">, </span><span class="s0">subject</span><span class="s1">, </span><span class="s0">template</span><span class="s1">, </span><span class="s0">**kwargs):</span>
    <span class="s0">msg = Message(subject</span><span class="s1">, </span><span class="s0">recipients=[to]</span><span class="s1">, </span><span class="s0">sender=app.config[</span><span class="s3">'MAIL_USERNAME'</span><span class="s0">])</span>
    <span class="s0">msg.html = render_template(template+ </span><span class="s3">'.html'</span><span class="s1">, </span><span class="s0">**kwargs )</span>
    <span class="s0">mail.send(msg)</span>


<span class="s1">def </span><span class="s0">mail_recover(to</span><span class="s1">, </span><span class="s0">subject</span><span class="s1">, </span><span class="s0">template</span><span class="s1">, </span><span class="s0">**kwargs):</span>

    <span class="s0">msg = Message(subject</span><span class="s1">, </span><span class="s0">recipients=[to]</span><span class="s1">, </span><span class="s0">sender=app.config[</span><span class="s3">'MAIL_USERNAME'</span><span class="s0">])</span>
    <span class="s0">msg.html = render_template(template+ </span><span class="s3">'.html'</span><span class="s1">, </span><span class="s0">**kwargs)</span>
    <span class="s0">mail.send(msg)</span>


<span class="s0">@app.route(</span><span class="s3">'/booking'</span><span class="s1">, </span><span class="s0">methods=[</span><span class="s3">'GET'</span><span class="s1">, </span><span class="s3">'POST'</span><span class="s0">])</span>
<span class="s1">def </span><span class="s0">booking():</span>

    <span class="s0">page_name = </span><span class="s3">&quot;Booking&quot;</span>
    <span class="s0">room_name = session.get(</span><span class="s3">'room_name'</span><span class="s0">)</span>
    <span class="s0">true_code = </span><span class="s1">False</span>

    <span class="s0">print(room_name)</span>
    <span class="s0">print(</span><span class="s3">&quot;BOOKING1&quot;</span><span class="s0">)</span>

    <span class="s2"># if session.get('room_name'):</span>
    <span class="s2">#     session['room_name'] = None</span>

    <span class="s0">form = Confirmation_code()</span>
    <span class="s1">if </span><span class="s0">session.get(</span><span class="s3">'active_user'</span><span class="s0">):</span>

        <span class="s1">if </span><span class="s0">form.validate_on_submit():</span>

            <span class="s0">print(</span><span class="s3">&quot;We entered here, that's already a lot! , keep going :)&quot;</span><span class="s0">)</span>

            <span class="s0">inserted_code = form.inserted_code.data</span>
            <span class="s0">print(inserted_code)</span>
            <span class="s0">print(room_name)</span>
            <span class="s0">real_room = Room.query.filter_by(name=room_name).first()</span>
            <span class="s0">real_code = real_room.confirmation_code</span>
            <span class="s0">email = session.get(</span><span class="s3">'active_user'</span><span class="s0">)</span>
            <span class="s0">bookings = Booking.query.filter_by(email_User=email).all()</span>
            <span class="s0">last_booking = bookings[-</span><span class="s4">1</span><span class="s0">]</span>
            <span class="s0">user = getUser(email)</span>

            <span class="s1">if </span><span class="s0">inserted_code == real_code:</span>
                <span class="s0">true_code = </span><span class="s1">True</span>
                <span class="s0">last_booking.yes_confirmed().__init__()</span>
                <span class="s0">user.one_more_booking()</span>
                <span class="s0">db.session.commit()</span>
                <span class="s0">bookings = Booking.query.filter_by(email_User=email).all()</span>
                <span class="s0">last_booking = bookings[-</span><span class="s4">1</span><span class="s0">]</span>
                <span class="s0">print(</span><span class="s3">&quot;THE ENTERED CODE IS CORRECT&quot;</span><span class="s0">)</span>
                <span class="s0">print(true_code)</span>
                <span class="s0">print(last_booking.getconfirmed())</span>

                <span class="s0">session[</span><span class="s3">'room_name'</span><span class="s0">] = </span><span class="s1">None</span>
                <span class="s0">flash(</span><span class="s3">&quot;Your booking has been confirmed, thank you&quot;</span><span class="s1">, </span><span class="s0">category=</span><span class="s3">'success'</span><span class="s0">)</span>

                <span class="s1">return </span><span class="s0">render_template(</span><span class="s3">&quot;booking.html&quot;</span><span class="s1">, </span><span class="s0">page_name=page_name</span><span class="s1">, </span><span class="s0">bookings=bookings</span><span class="s1">, </span><span class="s0">true_code=true_code)</span>

            <span class="s1">else</span><span class="s0">:</span>
                <span class="s0">true_code = </span><span class="s1">False</span>
                <span class="s0">print(</span><span class="s3">&quot;THE CODE IS INCORRECT&quot;</span><span class="s0">)</span>
                <span class="s0">print(last_booking.confirmed)</span>
                <span class="s0">print(true_code)</span>
                <span class="s0">print(</span><span class="s1">not </span><span class="s0">true_code)</span>
                <span class="s0">flash(</span><span class="s3">&quot;The inserted code is not valid, try again&quot;</span><span class="s1">, </span><span class="s0">category=</span><span class="s3">&quot;failure&quot;</span><span class="s0">)</span>
                <span class="s1">return </span><span class="s0">render_template(</span><span class="s3">&quot;booking.html&quot;</span><span class="s1">, </span><span class="s0">page_name=page_name</span><span class="s1">, </span><span class="s0">bookings=bookings</span><span class="s1">, </span><span class="s0">true_code=true_code</span><span class="s1">, </span><span class="s0">form=form)</span>

        <span class="s1">else</span><span class="s0">:</span>

            <span class="s0">email = session.get(</span><span class="s3">'active_user'</span><span class="s0">)</span>
            <span class="s0">user = User.query.filter_by(email=email).first()</span>
            <span class="s0">bookings = Booking.query.filter_by(email_User=email).all()</span>
            <span class="s0">counter_user = user.counter_booking</span>

            <span class="s1">if </span><span class="s0">len(bookings) &gt; </span><span class="s4">0</span><span class="s0">:</span>

                <span class="s0">true_code = </span><span class="s1">True</span>
                <span class="s0">last_booking = bookings[-</span><span class="s4">1</span><span class="s0">]</span>
                <span class="s0">print(last_booking.getconfirmed())</span>
                <span class="s0">print(</span><span class="s3">&quot;AT THE END OF BOOKING, TRUE OR FALSE&quot;</span><span class="s0">)</span>

                <span class="s1">if </span><span class="s0">last_booking.confirmed:</span>

                    <span class="s1">if </span><span class="s0">counter_user &gt;= </span><span class="s4">3</span><span class="s0">:</span>
                        <span class="s0">print(</span><span class="s3">&quot;IS THIS OKAYYYYYYYYYYYYY?&quot;</span><span class="s0">)</span>
                        <span class="s0">flash(</span><span class="s3">&quot;We are sorry but you are allowed to book only 3 times a day&quot;</span><span class="s1">, </span><span class="s0">category=</span><span class="s3">'failure'</span><span class="s0">)</span>

                        <span class="s0">db.session.commit()</span>
                        <span class="s1">return </span><span class="s0">render_template(</span><span class="s3">&quot;booking.html&quot;</span><span class="s1">, </span><span class="s0">user=user</span><span class="s1">,</span>
                                               <span class="s0">bookings=bookings</span><span class="s1">, </span><span class="s0">page_name=page_name</span><span class="s1">, </span><span class="s0">form=form</span><span class="s1">, </span><span class="s0">true_code=true_code)</span>
                    <span class="s1">else</span><span class="s0">:</span>

                        <span class="s0">true_code = </span><span class="s1">False</span>
                        <span class="s0">new_booking = Booking(name_StudyRoom=room_name</span><span class="s1">, </span><span class="s0">email_User=user.email)</span>
                        <span class="s0">new_booking.not_confirmed()</span>
                        <span class="s0">db.session.add(new_booking)</span>
                        <span class="s0">bookings = Booking.query.filter_by(email_User=email).all()</span>
                        <span class="s0">print(</span><span class="s3">&quot;BOOKING INTENTION DECLARED&quot;</span><span class="s0">)</span>
                        <span class="s0">Booked_room = Room.query.filter_by(name=room_name).first()</span>
                        <span class="s0">Booked_room.add_number_booking()</span>
                        <span class="s0">print(Booked_room.status)</span>
                        <span class="s0">db.session.commit()</span>

                        <span class="s0">print(new_booking.getconfirmed())</span>
                        <span class="s0">print(</span><span class="s3">&quot;IF AT THE END OF BOOKING&quot;</span><span class="s0">)</span>
                        <span class="s0">db.session.commit()</span>
                        <span class="s0">flash(</span><span class="s3">&quot;Booking created, you must confirm it within 30 minutes&quot;</span><span class="s1">, </span><span class="s0">category=</span><span class="s3">&quot;success&quot;</span><span class="s0">)</span>
                        <span class="s1">return </span><span class="s0">render_template(</span><span class="s3">&quot;booking.html&quot;</span><span class="s1">, </span><span class="s0">new_booking=new_booking</span><span class="s1">, </span><span class="s0">user=user</span><span class="s1">,</span>
                                            <span class="s0">bookings=bookings</span><span class="s1">, </span><span class="s0">page_name=page_name</span><span class="s1">, </span><span class="s0">form=form</span><span class="s1">, </span><span class="s0">true_code=true_code)</span>
                <span class="s1">else</span><span class="s0">:</span>
                    <span class="s0">flash(</span><span class="s3">&quot;You cannot have more bookings unless you confirm your last one&quot;</span><span class="s1">, </span><span class="s0">category=</span><span class="s3">&quot;failure&quot;</span><span class="s0">)</span>

                    <span class="s1">return </span><span class="s0">render_template(</span><span class="s3">&quot;booking.html&quot;</span><span class="s1">, </span><span class="s0">user=user</span><span class="s1">,</span>
                                   <span class="s0">bookings=bookings</span><span class="s1">, </span><span class="s0">page_name=page_name</span><span class="s1">, </span><span class="s0">form=form)</span>

            <span class="s1">else</span><span class="s0">:</span>

                <span class="s0">new_booking = Booking(name_StudyRoom=room_name</span><span class="s1">, </span><span class="s0">email_User=user.email)</span>
                <span class="s0">new_booking.not_confirmed()</span>
                <span class="s0">db.session.add(new_booking)</span>
                <span class="s0">print(new_booking.getconfirmed())</span>
                <span class="s0">print(</span><span class="s3">&quot;ELSE AT THE END OF BOOKING&quot;</span><span class="s0">)</span>

                <span class="s0">Booked_room = Room.query.filter_by(name=room_name).first()</span>
                <span class="s0">Booked_room.add_number_booking()</span>

                <span class="s0">bookings = Booking.query.filter_by(email_User=email).all()</span>

                <span class="s0">db.session.commit()</span>
                <span class="s0">flash(</span><span class="s3">&quot;Booking created, you must confirm it within 30 minutes&quot;</span><span class="s1">, </span><span class="s0">category=</span><span class="s3">&quot;success&quot;</span><span class="s0">)</span>
                <span class="s1">return </span><span class="s0">render_template(</span><span class="s3">&quot;booking.html&quot;</span><span class="s1">, </span><span class="s0">new_booking=new_booking</span><span class="s1">, </span><span class="s0">user=user</span><span class="s1">,</span>
                                       <span class="s0">bookings=bookings</span><span class="s1">, </span><span class="s0">page_name=page_name</span><span class="s1">, </span><span class="s0">form=form)</span>

    <span class="s1">else</span><span class="s0">:</span>

        <span class="s1">return </span><span class="s0">redirect(url_for(</span><span class="s3">&quot;home.html&quot;</span><span class="s0">))</span>


<span class="s2"># @app.route('/contactus', methods=['GET', 'POST'])</span>
<span class="s2"># def contactus():</span>
<span class="s2">#</span>
<span class="s2">#     return render_template(&quot;home.html&quot;)</span>


<span class="s0">@socketio.on(</span><span class="s3">'join'</span><span class="s1">, </span><span class="s0">namespace=</span><span class="s3">'/chat'</span><span class="s0">)</span>
<span class="s1">def </span><span class="s0">join(message):</span>
    <span class="s0">room = session.get(</span><span class="s3">'room_chat'</span><span class="s0">)</span>
    <span class="s0">join_room(room)</span>
    <span class="s0">name = getUser(session.get(</span><span class="s3">'active_user'</span><span class="s0">)).first_name</span>
    <span class="s0">emit(</span><span class="s3">'status'</span><span class="s1">, </span><span class="s0">{</span><span class="s3">'msg'</span><span class="s0">: name + </span><span class="s3">' has entered the chat.'</span><span class="s0">}</span><span class="s1">, </span><span class="s0">room=room)</span>


<span class="s0">@socketio.on(</span><span class="s3">'text'</span><span class="s1">, </span><span class="s0">namespace=</span><span class="s3">'/chat'</span><span class="s0">)</span>
<span class="s1">def </span><span class="s0">text(message):</span>
    <span class="s0">room = session.get(</span><span class="s3">'room_chat'</span><span class="s0">)</span>
    <span class="s0">name = getUser(session.get(</span><span class="s3">'active_user'</span><span class="s0">)).first_name</span>
    <span class="s0">emit(</span><span class="s3">'message'</span><span class="s1">, </span><span class="s0">{</span><span class="s3">'msg'</span><span class="s0">:  name + </span><span class="s3">' : ' </span><span class="s0">+ message[</span><span class="s3">'msg'</span><span class="s0">]}</span><span class="s1">, </span><span class="s0">room=room)</span>


<span class="s0">@socketio.on(</span><span class="s3">'left'</span><span class="s1">, </span><span class="s0">namespace=</span><span class="s3">'/chat'</span><span class="s0">)</span>
<span class="s1">def </span><span class="s0">left(message):</span>
    <span class="s0">room = session.get(</span><span class="s3">'room_chat'</span><span class="s0">)</span>
    <span class="s0">name = getUser(session.get(</span><span class="s3">'active_user'</span><span class="s0">)).first_name</span>
    <span class="s0">emit(</span><span class="s3">'status'</span><span class="s1">, </span><span class="s0">{</span><span class="s3">'msg'</span><span class="s0">: name + </span><span class="s3">' has left the chat.'</span><span class="s0">}</span><span class="s1">, </span><span class="s0">room=room)</span>
    <span class="s0">leave_room(room)</span>
    <span class="s0">session[</span><span class="s3">'room_chat'</span><span class="s0">] = </span><span class="s1">None</span>


<span class="s0">@app.route(</span><span class="s3">'/information'</span><span class="s1">, </span><span class="s0">methods=[</span><span class="s3">'GET'</span><span class="s1">, </span><span class="s3">'POST'</span><span class="s0">])</span>
<span class="s1">def </span><span class="s0">information():</span>

    <span class="s0">rooms = Room.query.all()</span>

    <span class="s1">if </span><span class="s0">session.get(</span><span class="s3">'active_user'</span><span class="s0">):</span>
        <span class="s0">active = </span><span class="s1">True</span>
    <span class="s1">else</span><span class="s0">:</span>
        <span class="s0">active = </span><span class="s1">False</span>

    <span class="s1">return </span><span class="s0">render_template(</span><span class="s3">&quot;information.html&quot;</span><span class="s1">, </span><span class="s0">active=active</span><span class="s1">, </span><span class="s0">rooms=rooms)</span>


<span class="s0">@app.route(</span><span class="s3">'/marcopolo'</span><span class="s1">, </span><span class="s0">methods=[</span><span class="s3">'GET'</span><span class="s1">,</span><span class="s3">'POST'</span><span class="s0">])</span>
<span class="s1">def </span><span class="s0">marcopolo():</span>

    <span class="s1">if </span><span class="s0">session.get(</span><span class="s3">'active_user'</span><span class="s0">):</span>
        <span class="s0">active = </span><span class="s1">True</span>
    <span class="s1">else</span><span class="s0">:</span>
        <span class="s0">active = </span><span class="s1">False</span>

    <span class="s0">name = </span><span class="s3">'marcopolo'</span>

    <span class="s0">room = Room.query.filter_by(name=name).first()</span>

    <span class="s2"># if room.status &gt;= room.capacity:</span>
    <span class="s2">#     user = session.get('active_user')</span>
    <span class="s2">#     return render_template(&quot;home.html&quot;, user=user)</span>

    <span class="s0">print(room.name)</span>
    <span class="s0">print(</span><span class="s3">&quot;MARCOPOLO APPROUTE&quot;</span><span class="s0">)</span>

    <span class="s0">room_name = room.name</span>
    <span class="s0">session[</span><span class="s3">&quot;room_name&quot;</span><span class="s0">] = room_name</span>

    <span class="s1">return </span><span class="s0">render_template(</span><span class="s3">&quot;deepinformation.html&quot;</span><span class="s1">, </span><span class="s0">active=active</span><span class="s1">, </span><span class="s0">room=room)</span>


<span class="s0">@app.route(</span><span class="s3">'/chat'</span><span class="s1">, </span><span class="s0">methods=[</span><span class="s3">'GET'</span><span class="s1">, </span><span class="s3">'POST'</span><span class="s0">])</span>
<span class="s1">def </span><span class="s0">chat():</span>
    <span class="s2"># / &lt; roomname &gt;</span>

    <span class="s0">room = request.form[</span><span class="s3">&quot;hidden&quot;</span><span class="s0">]</span>
    <span class="s2"># user = getUser(session.get('active_user'))</span>
    <span class="s0">session[</span><span class="s3">'room_chat'</span><span class="s0">] = room</span>

    <span class="s1">return </span><span class="s0">render_template(</span><span class="s3">&quot;chat.html&quot;</span><span class="s1">, </span><span class="s0">pagename=</span><span class="s3">&quot;Chat&quot;</span><span class="s1">, </span><span class="s0">room_chat=room)</span>


<span class="s0">@app.route(</span><span class="s3">'/personal'</span><span class="s1">, </span><span class="s0">methods=[</span><span class="s3">'GET'</span><span class="s1">, </span><span class="s3">'POST'</span><span class="s0">])</span>
<span class="s1">def </span><span class="s0">personal():</span>

    <span class="s0">user = getUser(session.get(</span><span class="s3">'active_user'</span><span class="s0">))</span>

    <span class="s0">bookings = Booking.query.filter_by(email_User=user.email).all()</span>

    <span class="s1">return </span><span class="s0">render_template(</span><span class="s3">&quot;personal_information.html&quot;</span><span class="s1">, </span><span class="s0">user=user</span><span class="s1">, </span><span class="s0">bookings=bookings)</span>

<span class="s0">@app.route(</span><span class="s3">'/bookings_list'</span><span class="s1">, </span><span class="s0">methods=[</span><span class="s3">'GET'</span><span class="s1">, </span><span class="s3">'POST'</span><span class="s0">])</span>
<span class="s1">def </span><span class="s0">bookings_list():</span>

    <span class="s0">form = Confirmation_code()</span>

    <span class="s0">user = getUser(session.get(</span><span class="s3">'active_user'</span><span class="s0">))</span>

    <span class="s0">bookings = Booking.query.filter_by(email_User=user.email).all()</span>

    <span class="s1">return </span><span class="s0">render_template(</span><span class="s3">&quot;bookings_list.html&quot;</span><span class="s1">, </span><span class="s0">bookings=bookings</span><span class="s1">, </span><span class="s0">form=form)</span>


<span class="s0">@app.route(</span><span class="s3">'/verdi'</span><span class="s1">, </span><span class="s0">methods=[</span><span class="s3">'GET'</span><span class="s1">, </span><span class="s3">'POST'</span><span class="s0">])</span>
<span class="s1">def </span><span class="s0">verdi():</span>

    <span class="s2"># print(request.form[&quot;hidden&quot;])</span>

    <span class="s1">if </span><span class="s0">session.get(</span><span class="s3">'active_user'</span><span class="s0">):</span>
        <span class="s0">active = </span><span class="s1">True</span>
    <span class="s1">else</span><span class="s0">:</span>
        <span class="s0">active = </span><span class="s1">False</span>

    <span class="s2"># name = request.form[&quot;hidden&quot;]</span>
    <span class="s0">name = </span><span class="s3">'verdi'</span>

    <span class="s0">room = Room.query.filter_by(name=name).first()</span>

    <span class="s2"># if room.status &gt;= room.capacity:</span>
    <span class="s2">#     user = session.get('active_user')</span>
    <span class="s2">#     return render_template(&quot;home.html&quot;, user=user)</span>

    <span class="s0">text_nearby = </span><span class="s3">&quot;&quot;</span>
    <span class="s0">super_text = []</span>

    <span class="s1">for </span><span class="s0">i </span><span class="s1">in </span><span class="s0">room.nearby_places:</span>

        <span class="s1">if </span><span class="s0">i == </span><span class="s3">&quot;)&quot;</span><span class="s0">:</span>
            <span class="s0">text_nearby += i</span>
            <span class="s0">super_text.append(text_nearby)</span>
            <span class="s0">text_nearby = </span><span class="s3">&quot;&quot;</span>
            <span class="s0">print(super_text)</span>
        <span class="s1">else</span><span class="s0">:</span>
            <span class="s0">text_nearby += i</span>




    <span class="s0">print(room.name)</span>
    <span class="s0">print(</span><span class="s3">&quot;VERDI APPROUTE&quot;</span><span class="s0">)</span>

    <span class="s0">room_name = room.name</span>
    <span class="s0">session[</span><span class="s3">&quot;room_name&quot;</span><span class="s0">] = room_name</span>

    <span class="s1">return </span><span class="s0">render_template(</span><span class="s3">&quot;deepinformation.html&quot;</span><span class="s1">, </span><span class="s0">active=active</span><span class="s1">, </span><span class="s0">room=room</span><span class="s1">, </span><span class="s0">super_text=super_text)</span>


<span class="s0">@app.route(</span><span class="s3">'/grugliasco'</span><span class="s1">, </span><span class="s0">methods=[</span><span class="s3">'GET'</span><span class="s1">, </span><span class="s3">'POST'</span><span class="s0">])</span>
<span class="s1">def </span><span class="s0">grugliasco():</span>

    <span class="s1">if </span><span class="s0">session.get(</span><span class="s3">'active_user'</span><span class="s0">):</span>
        <span class="s0">active = </span><span class="s1">True</span>
    <span class="s1">else</span><span class="s0">:</span>
        <span class="s0">active = </span><span class="s1">False</span>



    <span class="s2"># name = request.form[&quot;hidden&quot;]</span>
    <span class="s0">name = </span><span class="s3">'grugliasco'</span>
    <span class="s0">room = Room.query.filter_by(name=name).first()</span>

    <span class="s2"># if room.status &gt;= room.capacity:</span>
    <span class="s2">#     user = session.get('active_user')</span>
    <span class="s2">#     return render_template(&quot;home.html&quot;, user=user)</span>

    <span class="s0">room_name = room.name</span>
    <span class="s0">session[</span><span class="s3">&quot;room_name&quot;</span><span class="s0">] = room_name</span>

    <span class="s1">return </span><span class="s0">render_template(</span><span class="s3">&quot;deepinformation.html&quot;</span><span class="s1">, </span><span class="s0">active=active</span><span class="s1">, </span><span class="s0">room=room)</span>


<span class="s0">@app.route(</span><span class="s3">'/sansalvario'</span><span class="s1">, </span><span class="s0">methods=[</span><span class="s3">'GET'</span><span class="s1">, </span><span class="s3">'POST'</span><span class="s0">])</span>
<span class="s1">def </span><span class="s0">sansalvario():</span>

    <span class="s1">if </span><span class="s0">session.get(</span><span class="s3">'active_user'</span><span class="s0">):</span>
        <span class="s0">active = </span><span class="s1">True</span>
    <span class="s1">else</span><span class="s0">:</span>
        <span class="s0">active = </span><span class="s1">False</span>

    <span class="s2"># name = request.form[&quot;hidden&quot;]</span>
    <span class="s0">name = </span><span class="s3">'sansalvario'</span>
    <span class="s0">room = Room.query.filter_by(name=name).first()</span>

    <span class="s2"># if room.status &gt;= room.capacity:</span>
    <span class="s2">#     user = session.get('active_user')</span>
    <span class="s2">#     return render_template(&quot;home.html&quot;, user=user)</span>

    <span class="s0">room_name = room.name</span>
    <span class="s0">session[</span><span class="s3">&quot;room_name&quot;</span><span class="s0">] = room_name</span>

    <span class="s1">return </span><span class="s0">render_template(</span><span class="s3">&quot;deepinformation.html&quot;</span><span class="s1">, </span><span class="s0">active=active</span><span class="s1">, </span><span class="s0">room=room)</span>


<span class="s0">@app.route(</span><span class="s3">'/'</span><span class="s1">, </span><span class="s0">methods=[</span><span class="s3">'GET'</span><span class="s1">, </span><span class="s3">'POST'</span><span class="s0">])</span>
<span class="s1">def </span><span class="s0">home():</span>

    <span class="s0">user = session.get(</span><span class="s3">'active_user'</span><span class="s0">)</span>

    <span class="s1">return </span><span class="s0">render_template(</span><span class="s3">&quot;home.html&quot;</span><span class="s1">, </span><span class="s0">user=user)</span>


<span class="s0">@app.route(</span><span class="s3">'/logout'</span><span class="s1">, </span><span class="s0">methods=[</span><span class="s3">'GET'</span><span class="s1">, </span><span class="s3">'POST'</span><span class="s0">])</span>
<span class="s1">def </span><span class="s0">logout():</span>
    <span class="s0">session[</span><span class="s3">&quot;active_user&quot;</span><span class="s0">] = </span><span class="s1">None</span>
    <span class="s0">session[</span><span class="s3">&quot;active_user_name&quot;</span><span class="s0">] = </span><span class="s1">None</span>
    <span class="s1">return </span><span class="s0">redirect(url_for(</span><span class="s3">'home'</span><span class="s0">))</span>


<span class="s0">@app.route(</span><span class="s3">'/login'</span><span class="s1">, </span><span class="s0">methods=[</span><span class="s3">'GET'</span><span class="s1">, </span><span class="s3">'POST'</span><span class="s0">])</span>
<span class="s1">def </span><span class="s0">login():</span>

    <span class="s1">if </span><span class="s0">session.get(</span><span class="s3">&quot;active_user&quot;</span><span class="s0">):</span>

        <span class="s1">return </span><span class="s0">redirect(url_for(</span><span class="s3">'home'</span><span class="s0">))</span>

    <span class="s1">else</span><span class="s0">:</span>

        <span class="s0">form = Loginform()</span>
        <span class="s0">page_name = </span><span class="s3">&quot;Log-in&quot;</span>

        <span class="s1">if </span><span class="s0">form.validate_on_submit():</span>

            <span class="s0">email = form.email.data</span>
            <span class="s0">password = form.password.data</span>

            <span class="s0">existent_user = User.query.filter_by(email=email).first()</span>

            <span class="s1">if </span><span class="s0">existent_user:</span>

                <span class="s1">if </span><span class="s0">bcrypt.checkpw(password.encode(</span><span class="s3">'utf-8'</span><span class="s0">)</span><span class="s1">, </span><span class="s0">existent_user.password.encode(</span><span class="s3">'utf-8'</span><span class="s0">)):</span>
                    <span class="s0">session[</span><span class="s3">&quot;active_user&quot;</span><span class="s0">] = email</span>
                    <span class="s0">user = User.query.filter_by(email=email).first()</span>
                    <span class="s0">session[</span><span class="s3">&quot;active_user_name&quot;</span><span class="s0">] = user.first_name</span>
                    <span class="s1">return </span><span class="s0">redirect(url_for(</span><span class="s3">&quot;home&quot;</span><span class="s0">))</span>
                <span class="s1">else</span><span class="s0">:</span>
                    <span class="s0">flash(</span><span class="s3">&quot;Incorrect password&quot;</span><span class="s1">, </span><span class="s0">category=</span><span class="s3">'failure'</span><span class="s0">)</span>
            <span class="s1">else</span><span class="s0">:</span>
                <span class="s0">flash(</span><span class="s3">&quot; inexistent account with the inserted email, create an account or try again&quot;</span><span class="s1">, </span><span class="s0">category=</span><span class="s3">'failure'</span><span class="s0">)</span>

    <span class="s1">return </span><span class="s0">render_template(</span><span class="s3">&quot;login.html&quot;</span><span class="s1">, </span><span class="s0">form=form</span><span class="s1">, </span><span class="s0">page_name=page_name)</span>


<span class="s0">@app.route(</span><span class="s3">'/sign_up'</span><span class="s1">, </span><span class="s0">methods=[</span><span class="s3">'GET'</span><span class="s1">, </span><span class="s3">'POST'</span><span class="s0">])</span>
<span class="s1">def </span><span class="s0">sign_up():</span>
    <span class="s0">page_name = </span><span class="s3">&quot;Sign-up&quot;</span>
    <span class="s0">form = Registrationform()</span>

    <span class="s1">if </span><span class="s0">form.validate_on_submit():</span>

        <span class="s0">email = form.email.data</span>
        <span class="s0">first_name = form.first_name.data</span>
        <span class="s0">last_name = form.last_name.data</span>
        <span class="s0">password = form.password.data</span>
        <span class="s0">password1 = form.password1.data</span>

        <span class="s0">existent_user = User.query.filter_by(email=email).first()</span>

        <span class="s1">if </span><span class="s0">existent_user:</span>
            <span class="s0">flash(</span><span class="s3">&quot;An account with the inserted email already exists, please choose another one&quot;</span><span class="s1">, </span><span class="s0">category=</span><span class="s3">&quot;failure&quot;</span><span class="s0">)</span>
        <span class="s2"># flash('Account created', category='success')</span>
        <span class="s1">else</span><span class="s0">:</span>

            <span class="s0">session[</span><span class="s3">&quot;active_user&quot;</span><span class="s0">] = email</span>
            <span class="s0">user = User.query.filter_by(email=email).first()</span>
            <span class="s0">session[</span><span class="s3">&quot;active_user_name&quot;</span><span class="s0">] = first_name</span>
            <span class="s0">hashed_password = bcrypt.hashpw((password.encode(</span><span class="s3">'utf-8'</span><span class="s0">))</span><span class="s1">, </span><span class="s0">bcrypt.gensalt())</span>
            <span class="s0">hashed_password = hashed_password.decode(</span><span class="s3">'utf-8'</span><span class="s0">)</span>
            <span class="s0">new_user = User(email=email</span><span class="s1">, </span><span class="s0">first_name=first_name</span><span class="s1">, </span><span class="s0">last_name=last_name</span><span class="s1">, </span><span class="s0">password=hashed_password)</span>
            <span class="s0">new_user.counter_booking = </span><span class="s4">0</span>
            <span class="s0">db.session.add(new_user)</span>
            <span class="s0">db.session.commit()</span>
            <span class="s0">send_mail_register(email</span><span class="s1">, </span><span class="s3">&quot;Registration in BookTOStudy!&quot;</span><span class="s1">, </span><span class="s3">&quot;mail&quot;</span><span class="s1">, </span><span class="s0">name=first_name)</span>

            <span class="s1">return </span><span class="s0">redirect(url_for(</span><span class="s3">&quot;home&quot;</span><span class="s0">))</span>
    <span class="s1">else</span><span class="s0">:</span>

        <span class="s0">flash_errors(form)</span>

    <span class="s1">return </span><span class="s0">render_template(</span><span class="s3">&quot;signup.html&quot;</span><span class="s1">, </span><span class="s0">form=form</span><span class="s1">, </span><span class="s0">page_name=page_name)</span>


<span class="s0">@app.route(</span><span class="s3">'/recover_password'</span><span class="s1">, </span><span class="s0">methods=[</span><span class="s3">'GET'</span><span class="s1">, </span><span class="s3">'POST'</span><span class="s0">])</span>
<span class="s1">def </span><span class="s0">recover_password():</span>

    <span class="s0">page_name = </span><span class="s3">&quot;Recovery password process&quot;</span>
    <span class="s0">form = recover_password_form()</span>

    <span class="s1">if </span><span class="s0">session.get(</span><span class="s3">&quot;active_user&quot;</span><span class="s0">):</span>

        <span class="s1">return </span><span class="s0">redirect(url_for(</span><span class="s3">'home'</span><span class="s0">))</span>

    <span class="s1">else</span><span class="s0">:</span>

        <span class="s1">if </span><span class="s0">form.validate_on_submit():</span>

            <span class="s0">email = form.email.data</span>

            <span class="s0">S = </span><span class="s4">6</span>
            <span class="s0">new_code = </span><span class="s3">''</span><span class="s0">.join(random.sample(string.ascii_uppercase + string.digits</span><span class="s1">, </span><span class="s0">k=S))</span>

            <span class="s0">Code_object = Recovery_code.query.first()</span>

            <span class="s0">Code_object.code = new_code</span>
            <span class="s0">db.session.commit()</span>

            <span class="s0">user = getUser(email)</span>

            <span class="s1">if not </span><span class="s0">user:</span>

                <span class="s0">flash(</span><span class="s3">&quot;Inexistent user with the inserted email. Please control if you did not make any mistake&quot;</span><span class="s1">, </span><span class="s0">category=</span><span class="s3">'failure'</span><span class="s0">)</span>
                <span class="s1">return </span><span class="s0">render_template(</span><span class="s3">&quot;recover_password.html&quot;</span><span class="s1">, </span><span class="s0">page_name=page_name</span><span class="s1">, </span><span class="s0">form=form)</span>

            <span class="s1">else</span><span class="s0">:</span>

                <span class="s0">mail_recover(email</span><span class="s1">, </span><span class="s3">&quot;Password recovery&quot;</span><span class="s1">, </span><span class="s3">&quot;mail_recover&quot;</span><span class="s1">, </span><span class="s0">code=new_code</span><span class="s1">, </span><span class="s0">name=user.first_name)</span>

                <span class="s0">print(new_code)</span>
                <span class="s0">print(</span><span class="s3">&quot;Update in the database, which passes the new code as parameter and is compared with the one uploaded by the user&quot;</span><span class="s0">)</span>
                <span class="s0">session[</span><span class="s3">'email_password_recovery'</span><span class="s0">] = email</span>
                <span class="s0">page_name = </span><span class="s3">&quot;Code verification&quot;</span>

                <span class="s1">return </span><span class="s0">redirect(url_for(</span><span class="s3">&quot;confirmation_code&quot;</span><span class="s0">))</span>

        <span class="s1">else</span><span class="s0">:</span>
            <span class="s0">flash_errors(form)</span>

    <span class="s1">return </span><span class="s0">render_template(</span><span class="s3">&quot;recover_password.html&quot;</span><span class="s1">, </span><span class="s0">form=form</span><span class="s1">, </span><span class="s0">page_name=page_name)</span>







<span class="s0">@app.route(</span><span class="s3">'/confirmation_code'</span><span class="s1">, </span><span class="s0">methods=[</span><span class="s3">'GET'</span><span class="s1">,</span><span class="s3">'POST'</span><span class="s0">])</span>
<span class="s1">def </span><span class="s0">confirmation_code():</span>

    <span class="s0">page_name = </span><span class="s3">&quot;Recovery password process&quot;</span>
    <span class="s0">form = code_verification_form()</span>


    <span class="s1">if </span><span class="s0">session.get(</span><span class="s3">&quot;active_user&quot;</span><span class="s0">):</span>

        <span class="s1">return </span><span class="s0">redirect(url_for(</span><span class="s3">'home'</span><span class="s0">))</span>

    <span class="s1">else</span><span class="s0">:</span>

        <span class="s1">if </span><span class="s0">form.validate_on_submit():</span>

            <span class="s0">inserted_code = form.code.data</span>
            <span class="s0">database_code = Recovery_code.query.first().code</span>

            <span class="s1">if </span><span class="s0">inserted_code == database_code:</span>

                <span class="s1">return </span><span class="s0">redirect(url_for(</span><span class="s3">'password_change_page'</span><span class="s0">))</span>

            <span class="s1">else</span><span class="s0">:</span>
                <span class="s0">flash(</span><span class="s3">&quot;The inserted code is not valid, try again&quot;</span><span class="s1">, </span><span class="s0">category=</span><span class="s3">'failure'</span><span class="s0">)</span>
                <span class="s1">return </span><span class="s0">render_template(</span><span class="s3">&quot;confirmation_code.html&quot;</span><span class="s1">, </span><span class="s0">page_name=page_name</span><span class="s1">, </span><span class="s0">form=form)</span>

    <span class="s1">return </span><span class="s0">render_template(</span><span class="s3">&quot;confirmation_code.html&quot;</span><span class="s1">, </span><span class="s0">page_name=page_name</span><span class="s1">, </span><span class="s0">form=form)</span>


<span class="s0">@app.route(</span><span class="s3">'/password_change_page'</span><span class="s1">, </span><span class="s0">methods=[</span><span class="s3">'GET'</span><span class="s1">, </span><span class="s3">'POST'</span><span class="s0">])</span>
<span class="s1">def </span><span class="s0">password_change_page():</span>

    <span class="s0">user = getUser(session.get(</span><span class="s3">'email_password_recovery'</span><span class="s0">))</span>
    <span class="s0">name_page = </span><span class="s3">&quot;New password form&quot;</span>
    <span class="s0">form = changing_password()</span>
    <span class="s0">done = </span><span class="s1">False</span>

    <span class="s1">if </span><span class="s0">form.validate_on_submit():</span>

        <span class="s0">new_password = form.password.data</span>

        <span class="s0">hashed_password = bcrypt.hashpw((new_password.encode(</span><span class="s3">'utf-8'</span><span class="s0">))</span><span class="s1">, </span><span class="s0">bcrypt.gensalt())</span>
        <span class="s0">hashed_password = hashed_password.decode(</span><span class="s3">'utf-8'</span><span class="s0">)</span>

        <span class="s0">user.password = hashed_password</span>

        <span class="s0">done = </span><span class="s1">True</span>

        <span class="s0">db.session.commit()</span>

        <span class="s1">return </span><span class="s0">render_template(</span><span class="s3">&quot;password_change_page.html&quot;</span><span class="s1">, </span><span class="s0">done=done</span><span class="s1">, </span><span class="s0">name_page = name_page</span><span class="s1">, </span><span class="s0">form=form)</span>

    <span class="s1">else</span><span class="s0">:</span>
        <span class="s0">done = </span><span class="s1">False</span>
        <span class="s0">flash_errors(form)</span>
        <span class="s1">return </span><span class="s0">render_template(</span><span class="s3">&quot;password_change_page.html&quot;</span><span class="s1">, </span><span class="s0">form=form</span><span class="s1">, </span><span class="s0">name_page = name_page</span><span class="s1">, </span><span class="s0">done=done )</span>


<span class="s1">def </span><span class="s0">getUser(email):</span>

    <span class="s0">user = User.query.filter_by(email=email).first()</span>
    <span class="s1">return </span><span class="s0">user</span>



<span class="s0">@app.route(</span><span class="s3">'/delete/&lt;int:id&gt;'</span><span class="s1">, </span><span class="s0">methods=[</span><span class="s3">'GET'</span><span class="s1">, </span><span class="s3">'POST'</span><span class="s0">])</span>
<span class="s1">def </span><span class="s0">delete_booking(id):</span>

    <span class="s0">print(</span><span class="s3">&quot;The booking id is: &quot;</span><span class="s0">)</span>
    <span class="s0">print(id)</span>
    <span class="s0">print(</span><span class="s3">&quot;we are here boys&quot;</span><span class="s0">)</span>
    <span class="s0">selected_booking = Booking.query.filter_by(id=id).first()</span>
    <span class="s1">if </span><span class="s0">selected_booking:</span>
        <span class="s0">print (</span><span class="s3">&quot;we are here as well&quot;</span><span class="s0">)</span>
        <span class="s0">db.session.delete(selected_booking)</span>
        <span class="s0">room_name_delete = selected_booking.name_StudyRoom</span>
        <span class="s0">db.session.commit()</span>

        <span class="s0">email = session.get(</span><span class="s3">'active_user'</span><span class="s0">)</span>
        <span class="s0">user = User.query.filter_by(email=email).first()</span>
        <span class="s0">bookings = Booking.query.filter_by(email_User=email).all()</span>

        <span class="s0">page_name = </span><span class="s3">&quot;Booking&quot;</span>
        <span class="s0">true_code = </span><span class="s1">False</span>

        <span class="s0">room = Room.query.filter_by(name=room_name_delete).first()</span>
        <span class="s0">room.decrease_number_booking()</span>
        <span class="s0">db.session.commit()</span>

        <span class="s0">flash(</span><span class="s3">&quot;Your booking has been successfully canceled, thank you&quot;</span><span class="s1">, </span><span class="s0">category=</span><span class="s3">&quot;success&quot;</span><span class="s0">)</span>

        <span class="s2"># return redirect(url_for(&quot;booking&quot;))</span>
        <span class="s1">return </span><span class="s0">render_template(</span><span class="s3">&quot;booking.html&quot;</span><span class="s1">, </span><span class="s0">bookings=bookings</span><span class="s1">, </span><span class="s0">page_name = page_name</span><span class="s1">, </span><span class="s0">true_code = true_code)</span>
    <span class="s1">else</span><span class="s0">:</span>
        <span class="s0">print (</span><span class="s3">&quot;did not find any booking with such an id&quot;</span><span class="s0">)</span>


<span class="s1">if </span><span class="s0">__name__ == </span><span class="s3">'__main__'</span><span class="s0">:</span>
    <span class="s2"># app.run()</span>
    <span class="s0">socketio.run(app</span><span class="s1">, </span><span class="s0">host=</span><span class="s3">&quot;192.168.1.57&quot;</span><span class="s0">)</span>
</pre>
</body>
</html>